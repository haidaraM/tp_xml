<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="iso-8859-1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Partie Ajax par Yoam Hazot et Mohamed HAIDARA - B3446 </title>

    <!-- Bootstrap -->
    <link href="fichiersPourAjax/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        .instruction {
            font-style: italic;
            color: #006600;
        }

        .thumbnail-size {
            width: 96px;
            padding-right: 10px
        }

        .media-list li {
            padding: 5px
        }
    </style>
    <!-- Partie javascrit -->
    <script type="text/javascript">

        // variable pour checher si un bouton a été cliqué
        var clickBouton2 = false;
        var clickBouton3 = false;
        var clickBouton4 = false;
        //check if the first node is an element node
        function recupererPremierElementEnfant(n) {
            x = n.firstChild;
            while ( x.nodeType != 1 ) { // Test if x is an element node (and not a text node or other)
                x = x.nextSibling;
            }
            return x;
        }

        // transforme un document xml à travers une feuille de style xsl
        function xmlTransformByXsl(xmlDocumentUrl, xslDocumentUrl){
            var xsltProcessor = new XSLTProcessor();

            // Chargement du fichier XSL
            var xslDocument = getHttpXML(xslDocumentUrl);

            // Importation du .xsl
            xsltProcessor.importStylesheet(xslDocument);

            // Chargement du fichier XML
            var xmlDocument = getHttpXML(xmlDocumentUrl);

            // Création du document XML transformé par le XSL
            var newXmlDocuement = xsltProcessor.transformToDocument(xmlDocument);

            return newXmlDocuement;
        }

        // crée un div pour les informations en lab et le retourne
        function createDivLabel(responseJson){
            // Création de l'élément <div> correspondant aux caractéritiques du programme
            var moreInfos = document.createElement("div");

            // creation des labels
            var yearLabel = document.createElement("span");
            yearLabel.setAttribute("class", "label label-default");
            yearLabel.innerHTML = responseJson.Year;
            var ratedLabel = document.createElement("span");
            ratedLabel.setAttribute("class", "label label-default");
            ratedLabel.innerHTML = responseJson.Rated;
            var releasedLabel = document.createElement("span");
            releasedLabel.setAttribute("class", "label label-default");
            releasedLabel.innerHTML = responseJson.Released;
            var runtimeLabel = document.createElement("span");
            runtimeLabel.setAttribute("class", "label label-default");
            runtimeLabel.innerHTML = responseJson.Runtime;
            var genreLabel = document.createElement("span");
            genreLabel.setAttribute("class", "label label-default");
            genreLabel.innerHTML = responseJson.Genre;
            var languageLabel = document.createElement("span");
            languageLabel.setAttribute("class", "label label-default");
            languageLabel.innerHTML = responseJson.Language;
            var countryLabel = document.createElement("span");
            countryLabel.setAttribute("class", "label label-default");
            countryLabel.innerHTML = responseJson.Country;
            var imdbRatingLabel = document.createElement("span");
            imdbRatingLabel.setAttribute("class", "label label-default");
            imdbRatingLabel.innerHTML = responseJson.imdbRating;
            var imdbVotesLabel = document.createElement("span");
            imdbVotesLabel.setAttribute("class", "label label-default");
            imdbVotesLabel.innerHTML = responseJson.imdbVotes;

            //ajout des labels
            moreInfos.appendChild(yearLabel);
            moreInfos.appendChild(document.createTextNode (" "));
            moreInfos.appendChild(ratedLabel);
            moreInfos.appendChild(document.createTextNode (" "));
            moreInfos.appendChild(releasedLabel);
            moreInfos.appendChild(document.createTextNode (" "));
            moreInfos.appendChild(runtimeLabel);
            moreInfos.appendChild(document.createTextNode (" "));
            moreInfos.appendChild(genreLabel);
            moreInfos.appendChild(document.createTextNode (" "));
            moreInfos.appendChild(languageLabel);
            moreInfos.appendChild(document.createTextNode (" "));
            moreInfos.appendChild(countryLabel);
            moreInfos.appendChild(document.createTextNode (" "));
            moreInfos.appendChild(imdbRatingLabel);
            moreInfos.appendChild(document.createTextNode (" "));
            moreInfos.appendChild(imdbVotesLabel);

            return moreInfos;

        }

        // Modifie la couleur de l'arrière plan et la couleur du bouton
        function setBackgroundAndBoutonColor(){
            // récupération du body de la page
            var background = window.document.getElementById("body");
            background.style.backgroundColor ="#489AFF"

            // récuperation du bouton
            var bouton = window.document.getElementById("bouton1");
            bouton.style.color="white"
        }

        // Charge le fichier JSON se trouvant à l'URL donnée en paramètre et le retourne
        function getHttpJSON(jsonDocumentUrl) {

            var httpAjax;

            httpAjax = window.XMLHttpRequest ?
                    new XMLHttpRequest() :
                    new ActiveXObject('Microsoft.XMLHTTP');

            if (httpAjax.overrideMimeType) {
                httpAjax.overrideMimeType('text/xml');
            }

            // chargement du fichier JSON à l'aide de XMLHttpRequest synchrone (le 3° paramètre est défini à false)
            httpAjax.open('GET', jsonDocumentUrl, false);
            httpAjax.send();

            var responseData = eval("(" + httpAjax.responseText + ")");

            return responseData;
        }

        //charge le fichier XML se trouvant à l'URL relative donné dans le paramètre et le retourne
        function getHttpXML(xmlDocumentUrl) {

            var httpAjax;

            httpAjax = window.XMLHttpRequest ?
                    new XMLHttpRequest() :
                    new ActiveXObject('Microsoft.XMLHTTP');

            if (httpAjax.overrideMimeType) {
                httpAjax.overrideMimeType('text/xml');
            }

            //chargement du fichier XML à l'aide de XMLHttpRequest synchrone (le 3° paramètre est défini à false)
            httpAjax.open('GET', xmlDocumentUrl, false);
            httpAjax.send();

            return httpAjax.responseXML;
        }

        // affiche les informations des évènements dont le titre contient le mot "Workaholics"
        function infoWorkaholics(xmlDocumentUrl,xslDocumentUrl,urlJson){

            // creation du bouton
            var bouton = document.createElement("button");
            // creation du texte du bouton
            var text = document.createTextNode("Bouton 3 (fn : MajInfoWorkaholics)");

            // attributs du bouton : fonction à declencher et css
            var parameters = "MajInfoWorkaholics(\"" + urlJson +"\")";
            bouton.setAttribute("onclick",parameters);
            bouton.setAttribute("class","btn btn-default");

            bouton.appendChild(text);
            var li = document.createElement("li");
            li.appendChild(bouton);

            // Création du document XML transformé par le XSL
            var newXmlDocument = xmlTransformByXsl(xmlDocumentUrl,xslDocumentUrl);

            // recuperation du noeud dans le nouveau document
            var elementAInserer = newXmlDocument.getElementsByTagName("ul")[0];

            // pour éviter plusieurs boutons et informations concernant la série
            if(clickBouton2 == false){
                clickBouton2 = true;

                //petit saut de ligne
                document.getElementById("liste_bouton").appendChild(document.createElement("br"));

                // ajout du bouton
                document.getElementById("liste_bouton").appendChild(li);

                // ajout du noeud recupéré dans le document transformé
                document.getElementById("aCompleterBouton2").appendChild(elementAInserer);
            }
        }

        //crée une balise a avec une image dont l'url est passé en paramètre => renvoie le lien (la balise a)
        function createImage(poster){

            // creation du lien et mise en place des attributs
            var lien = document.createElement("a");
            lien.setAttribute("class","pull-left thumbnail-size");
            lien.setAttribute("href",poster);

            // creation de l'image et mise en place des attributs
            var image = document.createElement("img");
            image.setAttribute("class","media-object img-thumbnail responsive");
            image.setAttribute("src",poster);

            // ajout de l'image au lien
            lien.appendChild(image);

            return lien;

        }

        // recupere les informations à partir de l'API omdb
        function MajInfoWorkaholics(urlJSOn){

            // Chargement du fichier JSON
            var response = getHttpJSON(urlJSOn);

            // on recupere le noeud li
            var liListe = document.getElementById("aCompleterBouton2").getElementsByClassName("media")[0];

            // Création de l'élément <div> correspondant aux caractéritiques du programme
            var moreInfos = createDivLabel(response);

            if(clickBouton3 == false){
                clickBouton3 = true;
                // création et ajout de l'image
                var lien = createImage(response.Poster);

                // insertion du lien avant le media-body
                liListe.insertBefore(lien,liListe.childNodes[0]);

                // ajout des labels dans le noeud
                liListe.getElementsByClassName("media-body")[0].appendChild(moreInfos);
            }

        }

        //affiche le calendrier complet en utilisant une feuille de style
        function afficheCalendrier(xmlDocumentUrl,xslDocumentUrl){
            // creation du bouton
            var bouton = document.createElement("button");
            // creation du texte du bouton
            var text = document.createTextNode("Bouton 5 (fn : MajAfficheCalendrier)");

            // creation et récuperation du nouveau document transformé
            var xmlDocumentTransformed = xmlTransformByXsl(xmlDocumentUrl, xslDocumentUrl);
            // récuperation de la liste des elements
            var listeElementsAInserer = xmlDocumentTransformed.getElementsByTagName("ul");

            // attributs du bouton : fonction à declencher et css
            bouton.setAttribute("onclick","MajAfficheCalendrier()" );
            bouton.setAttribute("class","btn btn-default");
            bouton.appendChild(text);
            var li = document.createElement("li");
            li.appendChild(bouton);

            if(clickBouton4 == false)
            {
                // affichage du bouton
                document.getElementById("liste_bouton2").appendChild(li);

                clickBouton4 = true;
                // parcours et affichage de la liste des éléments
                for(var j=0; j<listeElementsAInserer.length;j++){
                    // ajout du noeud recupéré dans le document transformé
                    document.getElementById("aCompleterBouton4").appendChild(listeElementsAInserer[j]);
                    j--; // sans ça je ne sais pas pourquoi ça ne marche pas, le javascript est trop bizard
                }
                //petit saut de ligne
                document.getElementById("aCompleterBouton4").appendChild(document.createElement("br"));

            }
        }

        // met à jour le calendrier complet en ajoutant des images et autres infos
        function MajAfficheCalendrier(){

            // récuperation de la liste des elements
            var listeElementsAInserer = document.getElementById("aCompleterBouton4").getElementsByClassName("media");

            for(var k=0; k<listeElementsAInserer.length;k++){
                // on recupere le titre de la série courante
                var titre = listeElementsAInserer[k].getElementsByClassName("media-heading")[0];
                //on cree l'url json avec le titre de la série
                var urlJson = "http://www.omdbapi.com/?t="+titre.innerHTML+"&y=&plot=short&r=json";
                // Chargement du fichier JSON
                var response = getHttpJSON(urlJson);

                // création et ajout de l'image
                var lien = createImage(response.Poster);

                // insertion du lien avant le media-body
                listeElementsAInserer[k].insertBefore(lien,listeElementsAInserer[k].childNodes[0]);

                var moreInfo = createDivLabel(response);
                // ajout des labels dans le noeud
                listeElementsAInserer[k].getElementsByClassName("media-body")[0].appendChild(moreInfo);
            }
        }

        function bonus(){

        }

    </script>
</head>

<body id="body">
<div class="container">
    <h1> Partie Ajax par Yoam HAZOT et Mohamed HAIDARA - B3446 </h1>

    <h2>Travail réalisé</h2>
    <p>
    <ul id="liste_bouton">
        <li>
            <input id="bouton1" class="btn btn-default" value="Bouton 1 (fn :setBackgroundAndBoutonColor) " type="button" onclick="setBackgroundAndBoutonColor()"/>
        </li> <br/>
        <li>
            <input id="bouton2" class="btn btn-default" value="Bouton 2 (fn: infoWorkaholics)" type="button" onclick="infoWorkaholics('fichiersPourAjax/calendar-short.xml','fichiersPourAjax/calendar-eventlist-workaholics.xsl','http://www.omdbapi.com/?t=workaholics&y=&plot=short&r=json')"/>
        </li>
    </ul>

    <div id="aCompleterBouton2"> </div> <br/>

    <ul id="liste_bouton2">
        <li>
            <input id="bouton4" class="btn btn-default" value="Bouton 4 (fn :afficheCalendrier) " type="button" onclick="afficheCalendrier('fichiersPourAjax/calendar-full.xml','fichiersPourAjax/calendar-eventlist.xsl')"/>
        </li><br/>
    </ul>
    <div id="aCompleterBouton4"> </div>

    <ul>
        <li>
            <input id="bouton6" value="Bouton Bonus (fn : bonus)" type="button" class="btn btn-success">
        </li>
    </ul>
    </p>
</div>
</body>
</html>